name: tariff-service-deploy

on:
  push:
    branches:
      - main
    paths:
      - "services/tariff_service/**"
      - ".github/workflows/tariff_service_deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
      YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
      YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
      YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
      YC_CONTAINER_NAME: ${{ secrets.YC_CONTAINER_NAME }}
      YC_SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug credentials (masked)
        run: |
          set -euo pipefail

          mask() {
            local value="$1"
            local length=${#value}
            if [ "$length" -ge 8 ]; then
              printf '%sâ€¦%s' "${value:0:4}" "${value:length-4:4}"
            else
              printf '<too short>'
            fi
          }

          print_masked_var() {
            local var_name="$1"
            local value="${!var_name:-}"
            if [ -n "$value" ]; then
              printf '%s: set (len=%s, masked=%s)\n' "$var_name" "${#value}" "$(mask "$value")"
            else
              printf '%s: unset\n' "$var_name"
            fi
          }

          required_vars=(YC_CLOUD_ID YC_FOLDER_ID YC_REGISTRY_ID YC_SERVICE_ACCOUNT_ID)
          for var_name in "${required_vars[@]}"; do
            if [ -z "${!var_name:-}" ]; then
              echo "Missing required variable: $var_name"
              exit 1
            fi
          done

          if [ -z "${YC_SA_KEY_JSON:-}" ]; then
            echo "Missing required variable: YC_SA_KEY_JSON"
            exit 1
          fi

          echo "Checking Yandex Cloud variables (masked):"
          print_masked_var YC_CLOUD_ID
          print_masked_var YC_FOLDER_ID
          print_masked_var YC_REGISTRY_ID
          print_masked_var YC_SERVICE_ACCOUNT_ID
          print_masked_var YC_CONTAINER_NAME

          KEY_PATH="$RUNNER_TEMP/key.json"
          printf '%s' "$YC_SA_KEY_JSON" > "$KEY_PATH"

          python - "$KEY_PATH" <<'PY'
          import json
          import sys

          path = sys.argv[1]
          with open(path, encoding="utf-8") as fh:
              data = json.load(fh)

          if not isinstance(data, dict):
              raise SystemExit("key.json parsed, but top-level JSON is not an object")

          important = ["id", "service_account_id", "created_at"]
          present = [field for field in important if field in data]
          print("key.json parsed ok; fields present:", "/".join(present) if present else "none-of-id-service_account_id-created_at")
          print("key.json top-level keys:", ", ".join(sorted(data.keys())[:20]))
          PY

          CONTAINER_NAME="${YC_CONTAINER_NAME:-tariff-service}"
          if [ -z "$CONTAINER_NAME" ]; then
            CONTAINER_NAME="tariff-service"
          fi

          IMAGE="cr.yandex/${YC_REGISTRY_ID}/tariff-service:${GITHUB_SHA}"
          echo "CONTAINER_NAME=$CONTAINER_NAME"
          echo "IMAGE=$IMAGE"

          echo "CONTAINER_NAME=$CONTAINER_NAME" >> "$GITHUB_ENV"
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

      - name: Install yc CLI
        run: |
          set -euo pipefail
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"

      - name: Authorize yc CLI
        run: |
          set -euo pipefail

          SA_KEY_PATH="$RUNNER_TEMP/yc-sa-key.json"
          printf '%s' "$YC_SA_KEY_JSON" > "$SA_KEY_PATH"

          "$HOME/yandex-cloud/bin/yc" config profile create ci-profile || true
          "$HOME/yandex-cloud/bin/yc" config set service-account-key "$SA_KEY_PATH"
          "$HOME/yandex-cloud/bin/yc" config set cloud-id "$YC_CLOUD_ID"
          "$HOME/yandex-cloud/bin/yc" config set folder-id "$YC_FOLDER_ID"

          echo "yc profile configured for cloud/folder from secrets"

      - name: Debug yc context (safe)
        run: |
          set -euo pipefail
          yc --version
          yc config get cloud-id
          yc config get folder-id
          yc config profile list
          yc config profile get ci-profile

      - name: Configure Docker auth for Yandex Container Registry
        run: |
          set -euo pipefail
          yc container registry configure-docker

      - name: Build and push Docker image
        env:
          IMAGE_SHA: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/tariff-engine:${{ github.sha }}
          IMAGE_LATEST: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/tariff-engine:latest
        run: |
          set -euo pipefail

          echo "Building image from context: services/tariff_service"
          docker build \
            -t "$IMAGE_SHA" \
            -t "$IMAGE_LATEST" \
            services/tariff_service

          docker push "$IMAGE_SHA"
          docker push "$IMAGE_LATEST"

          echo "IMAGE_SHA=$IMAGE_SHA" >> "$GITHUB_ENV"

      - name: Deploy Serverless Container revision
        run: |
          set -euo pipefail

          : "${YC_SERVICE_ACCOUNT_ID:?YC_SERVICE_ACCOUNT_ID is required}"

          echo "Deploying container revision to: $CONTAINER_NAME"
          echo "Image: $IMAGE_SHA"

          # Container name comes from YC_CONTAINER_NAME secret if provided.
          # Default fallback is tariff-engine.
          # Tune MVP resources below for your workload:
          # --cores, --memory, --concurrency, --execution-timeout
          yc serverless container revision deploy \
            --container-name "$CONTAINER_NAME" \
            --image "$IMAGE_SHA" \
            --service-account-id "$YC_SERVICE_ACCOUNT_ID" \
            --cores 1 \
            --memory 512MB \
            --concurrency 4 \
            --execution-timeout 10s
